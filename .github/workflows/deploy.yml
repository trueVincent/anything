name: Build and Deploy to EC2

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

jobs:    
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Build on EC2 via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd anything
            git pull -f
            echo "Removing existing containers"
            sudo docker rm -f todo-nginx 2>/dev/null || true
            sudo docker rm -f todo-app 2>/dev/null || true
            echo "Building Django app service..."
            sudo docker build -t todo-app ./todo/.
            sudo docker run --run --network todo -e ENV=prod todo-app python manage.py migrate
            echo "Building Nginx..."
            sudo docker build -t todo-nginx ./deployment/nginx/.
            echo "All services builded successfully!"
            
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd anything
            echo "Starting Django app service..."
            sudo docker run --name todo-app --network todo -p 8000:8000 -e ENV=prod \
              -v /mnt/app-logs:/app/logs \
              -v /mnt/app-media:/mnt/media \
              -v /mnt/app-static:/mnt/static \
              -d todo-app \
              gunicorn -c ./todo/gunicorn_config.py todo.todo.wsgi:application
            echo "Starting Nginx..."
            sudo docker run --name todo-nginx --network todo -p 80:80 \
              -v /mnt/app-static:/mnt/app-static \
              -d todo-nginx
            echo "All services started successfully!"
